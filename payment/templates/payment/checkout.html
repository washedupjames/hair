{% include "store/base.html" %}

{% load static %}

{% block content %}

<style>
    body {
        background-color: gray;
    }
</style>

<body>

    <br>

    <div class="container bg-white shadow-md p-5 checkout-container">
        <form id="form" method="post" onsubmit="event.preventDefault()">
            {% csrf_token %}

            <div>

                <h3> <i class="fa fa-chevron-circle-right" aria-hidden="true"></i>   Complete your order </h3>

                <p> Please enter in the relevant information below. </p>

                <hr>

                <br>

                <div class="form-field">
                    <input class="form-control validate" id="name" name="name" type="text" placeholder="Full name*" autocomplete="off" value="{{shipping.full_name}}" required>
                </div>

                <br>

                <div class="form-field">
                    <input class="form-control validate" id="email" name="email" type="email" placeholder="Email address*" autocomplete="off" value="{{shipping.email}}" required>
                </div>

                <br>

                <div class="form-field">
                    <input class="form-control validate" id="address1" name="address1" type="text" placeholder="Address 1*" autocomplete="off" value="{{shipping.address1}}" required>
                </div>

                <br>

                <div class="form-field">
                    <input class="form-control validate" id="address2" name="address2" type="text" placeholder="Address 2*" autocomplete="off" value="{{shipping.address2}}" required>
                </div>

                <br>

                <div class="form-field">
                    <input class="form-control validate" id="city" name="city" type="text" placeholder="City*" autocomplete="off" value="{{shipping.city}}" required>
                </div>

                <br>

                <div class="form-field">
                    <input class="form-control" id="state" name="state" type="text" placeholder="County (Optional)" autocomplete="off" value="{{shipping.county}}">
                </div>

                <br>

                <div class="form-field">
                    <input class="form-control validate" id="zipcode" name="zipcode" type="text" placeholder="Postcode (Optional)" autocomplete="off" value="{{shipping.zipcode}}">
                </div>

                <br>
                <p> Please enter your country for delivery price to be added to your total. </p>
                <hr>

                <div class="form-field">
                    <select class="form-control validate" id="country" name="country" required onchange="updateShippingCost()">
                        <option value="" disabled selected>Select Country*</option>
                        {% for code, name in COUNTRY_CHOICES %}
                            <option value="{{ code }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

            </div>

            <br>

            <!-- Display Shipping and Total Cost -->
            <p id="shipping-cost">Shipping Cost: £0.00</p>
            <p id="total-cost">Total Cost: £{{ cart_total }}</p>

            <!-- Pay Pal -->

            <div id="paypal-button-container"></div>

            <script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=GBP&intent=capture&enable-funding=venmo" data-sdk-integration-source="integrationbuilder"></script>

            
        </form>
  
    </div>

    <br>

</body>


    <!-- Ajax integration -->

    
    <script>
        // Total price
        var total_price = '{{ cart_total }}';
    
        // Function to update shipping cost based on country
        function updateShippingCost() {
            var country = document.getElementById('country').value;
            var domesticRate = 3.00;  // UK shipping rate
            var internationalRate = 5.00;  // International shipping rate
            
            // Check if the country is UK (GB)
            if (country === 'GB') {
                document.getElementById('shipping-cost').innerText = 'Shipping Cost: £' + domesticRate.toFixed(2);
                updateTotalCost(domesticRate);
            } else {
                document.getElementById('shipping-cost').innerText = 'Shipping Cost: £' + internationalRate.toFixed(2);
                updateTotalCost(internationalRate);
            }
        }
    
        // Function to update total cost
        function updateTotalCost(shippingCost) {
            var cartTotal = parseFloat('{{ cart_total }}');
            var totalCost = cartTotal + shippingCost;
            document.getElementById('total-cost').innerText = 'Total Cost: £' + totalCost.toFixed(2);
            
            // Update total_price for PayPal
            total_price = totalCost.toFixed(2);
        }
    
        // Initial call to set shipping cost when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Here we set a default country or let it be empty
            document.getElementById('country').value = ''; // Or set to 'GB' if you want UK as default
            updateShippingCost();
        });
    
        // pay pal script
        const paypalButtonsComponent = paypal.Buttons({
            // optional styling for buttons
            // https://developer.paypal.com/docs/checkout/standard/customize/buttons-style-guide/
            style: {
              color: "gold",
              shape: "pill",
              layout: "vertical"
            },
    
            onInit: function(data, actions) {
                actions.disable();
    
                // Complete order - NO SHIPPING
                document.querySelectorAll('.validate').forEach(item => {
                    item.addEventListener('keyup', event => {
                        //  The required fields are filled out
                        var order_verified = 'Yes';
    
                        function checkInputs(){
                            $(':input[required]').each(function(){
                                if($(this).val() == ''){
                                    // The required fields are empty
                                    return order_verified = 'No';
                                }
                            });
                            return order_verified;
                        }
    
                        var isOrderVerified = checkInputs()
    
                        if(isOrderVerified === 'Yes') {
                            actions.enable();
                        } else {
                            actions.disable();
                        }
                    });
                });
    
                // Complete order - WITH SHIPPING
                //  The required fields are filled out
                var order_verified = 'Yes';
    
                function checkInputs(){
                    $(':input[required]').each(function(){
                        if($(this).val() == ''){
                            // The required fields are empty
                            return order_verified = 'No';
                        }
                    });
                    return order_verified;
                }
    
                var isOrderVerified = checkInputs()
    
                if(isOrderVerified === 'Yes') {
                    actions.enable();
                } else {
                    actions.disable();
                }
            },
    
            // set up the transaction
            createOrder: (data, actions) => {
                // pass in any options from the v2 orders create call:
                // https://developer.paypal.com/api/orders/v2/#orders-create-request-body
                const createOrderPayload = {
                    purchase_units: [
                        {
                            amount: {
                                value: total_price
                            }
                        }
                    ]
                };
    
                return actions.order.create(createOrderPayload);
            },
    
            // finalize the transaction
            onApprove: (data, actions) => {
                const captureOrderHandler = (details) => {
                    const payerName = details.payer.name.given_name;
                    console.log('Transaction completed');
    
                    // ajax functionality
                    $.ajax({
                        type: 'POST',
                        url: '{% url "complete-order" %}',
                        data: {
                            name: $('#name').val(),
                            email: $('#email').val(),
                            address1: $('#address1').val(),
                            address2: $('#address2').val(),
                            city: $('#city').val(),
                            state: $('#state').val(),
                            zipcode: $('#zipcode').val(),
                            country: $('#country').val(),
                            csrfmiddlewaretoken: "{{ csrf_token }}",
                            action: 'post'
                        },
                        success: function(json){
                            window.location.replace("{% url 'payment-success' %}");
                        },
                        error: function(xhr, errmsg, err){
                            window.location.replace("{% url 'payment-failed' %}");
                        }
                    });
                };
    
                return actions.order.capture().then(captureOrderHandler);
            },
    
            // handle unrecoverable errors
            onError: (err) => {
                console.error('An error prevented the buyer from checking out with PayPal');
            }
        });
    
        paypalButtonsComponent
            .render("#paypal-button-container")
            .catch((err) => {
                console.error('PayPal Buttons failed to render');
            });
    </script>




{% endblock %}