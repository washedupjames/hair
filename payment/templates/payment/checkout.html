{% include "store/base.html" %}

{% load static %}

{% block content %}

<style>
    body {
        background-color: gray;
    }

    @media (max-width: 767px) {
        .cart-quantity {
            display: none; /* Hide the quantity if it's zero on mobile */
        }
        .cart-quantity:not(:empty) {
            display: inline; /* Show it when there's something in the cart */
        }
    }
</style>

<body>

    <br>

    <div class="container bg-white shadow-md p-5 form-layout">
        <form id="form" method="post" onsubmit="event.preventDefault()">
            {% csrf_token %}

            <div>

                <h3> <i class="fa fa-chevron-circle-right" aria-hidden="true"></i>   Complete your order </h3>

                <p> Please enter in the relevant information below. </p>

                <hr>

                <br>

                <!-- Your existing form fields here -->

                <br>

                <!-- Show Cart Quantity -->
                <p>
                    <span class="cart-quantity" id="cart-quantity">
                        {% if cart_quantity > 0 %}
                            {{ cart_quantity }}
                        {% endif %}
                    </span> 
                    items in your cart
                </p>

                <!-- Pay Pal -->

                <div id="paypal-button-container"></div>

                <script src="https://www.paypal.com/sdk/js?client-id={{ SANDBOX_PAYPAL_CLIENT_ID }}¤cy=GBP&intent=capture&enable-funding=venmo" data-sdk-integration-source="integrationbuilder"></script>

            </div>
        </form>
  
    </div>

    <br>

</body>

<!-- Ajax integration -->

<script>
    // Total price
    var total_price = '{{ cart_total }}';

    // Function to update shipping cost based on country
    function updateShippingCost() {
        var country = document.getElementById('country').value;
        var domesticRate = 3.00;  // UK shipping rate
        var internationalRate = 5.00;  // International shipping rate
        
        // Check if the country is UK (GB)
        if (country === 'GB') {
            document.getElementById('shipping-cost').innerText = 'Shipping Cost: £' + domesticRate.toFixed(2);
            updateTotalCost(domesticRate);
        } else {
            document.getElementById('shipping-cost').innerText = 'Shipping Cost: £' + internationalRate.toFixed(2);
            updateTotalCost(internationalRate);
        }
    }

    // Function to update total cost
    function updateTotalCost(shippingCost) {
        var cartTotal = parseFloat('{{ cart_total }}');
        var totalCost = cartTotal + shippingCost;
        document.getElementById('total-cost').innerText = 'Total Cost: £' + totalCost.toFixed(2);
        
        // Update total_price for PayPal
        total_price = totalCost.toFixed(2);
    }

    // Initial call to set shipping cost when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Here we set a default country or let it be empty
        document.getElementById('country').value = ''; // Or set to 'GB' if you want UK as default
        updateShippingCost();

        // Update cart quantity display
        fetch('{% url 'update_cart_display' %}')
            .then(response => response.json())
            .then(data => {
                var cartQty = document.getElementById('cart-quantity');
                cartQty.textContent = data.cart_quantity > 0 ? data.cart_quantity : '';
            });

        // Function to check form validity, now using actions from PayPal
        function checkFormValidity(actions) {
            console.log('Checking form validity...');
            var isFormValid = true;
    
            $(':input[required]').each(function(){
                console.log('Checking:', this.id, $(this).val());
                if($(this).val() === ''){
                    console.log('Field', this.id, 'is empty');
                    isFormValid = false;
                }
            });
    
            var countryValue = $('#country').val();
            console.log('Country:', countryValue);
            if (countryValue === '' || countryValue === null) {
                console.log('Country not selected');
                isFormValid = false;
            }
    
            console.log('Form Validity:', isFormValid);

            if (isFormValid) {
                console.log('Enabling PayPal button');
                actions.enable();
            } else {
                console.log('Disabling PayPal button');
                actions.disable();
            }
        }

        // PayPal script
        paypal.Buttons({
            // optional styling for buttons
            // https://developer.paypal.com/docs/checkout/standard/customize/buttons-style-guide/
            style: {
              color: "gold",
              shape: "pill",
              layout: "vertical"
            },
    
            onInit: function(data, actions) {
                actions.disable(); // Start with the button disabled

                // Add event listeners for form validation
                document.getElementById('country').addEventListener('change', function() {
                    updateShippingCost(); 
                    checkFormValidity(actions);
                });

                document.querySelectorAll('.validate').forEach(item => {
                    if(item.tagName.toLowerCase() !== 'select') {
                        item.addEventListener('keyup', function() {
                            checkFormValidity(actions);
                        });
                    }
                    item.addEventListener('change', function() {
                        checkFormValidity(actions);
                    });
                });

                // Initial check on page load
                checkFormValidity(actions);
            },
    
            // set up the transaction
            createOrder: (data, actions) => {
                const createOrderPayload = {
                    purchase_units: [
                        {
                            amount: {
                                value: total_price
                            }
                        }
                    ]
                };
    
                return actions.order.create(createOrderPayload);
            },
    
            // finalize the transaction
            onApprove: (data, actions) => {
                const captureOrderHandler = (details) => {
                    console.log('Transaction completed');

                    $.ajax({
                        type: 'POST',
                        url: '{% url "complete-order" %}',
                        data: {
                            name: $('#name').val(),
                            email: $('#email').val(),
                            address1: $('#address1').val(),
                            address2: $('#address2').val(),
                            city: $('#city').val(),
                            state: $('#state').val(),
                            zipcode: $('#zipcode').val(),
                            country: $('#country').val(),
                            csrfmiddlewaretoken: "{{ csrf_token }}",
                            action: 'post'
                        },
                        success: function(json){
                            window.location.replace("{% url 'payment-success' %}");
                        },
                        error: function(xhr, errmsg, err){
                            window.location.replace("{% url 'payment-failed' %}");
                        }
                    });
                };

                return actions.order.capture().then(captureOrderHandler);
            },
    
            // handle unrecoverable errors
            onError: (err) => {
                console.error('An error prevented the buyer from checking out with PayPal');
            }
        }).render("#paypal-button-container").catch((err) => {
            console.error('PayPal Buttons failed to render', err);
        });
    });
</script>

{% endblock %}